<!DOCTYPE html>
<meta charset='utf-8'>
<style>

path {
  fill: #ddd;
  fill-opacity: .8;
  stroke: #fff;
  stroke-width: 1.5px;
}

line {
  stroke: #999;
}

</style>
<body>
<script src='../d3.v3.min.js'></script>
<script src='../topojson.v1.min.js'></script>
<script>
/* globals d3, topojson */

'use strict';

var width = 960,
    height = 500;

var pathObj = d3.geo.path(),
    forceObj = d3.layout.force().size([width, height]);

var svg = d3.select('body').append('svg')
    .attr('width', width)
    .attr('height', height);

d3.json('../us.json', function(error, us) {
  if (error) throw error;

  var statesData = topojson.feature(us, us.objects.statesData);
  var nodeObjs = [];
  var linkObjs = [];

  statesData.features.forEach(function(d, i) {
    if (d.id === 2 || d.id === 15 || d.id === 72) return; // lower 48
    var centroid = pathObj.centroid(d);
    if (centroid.some(isNaN)) return;
    centroid.x = centroid[0];
    centroid.y = centroid[1];
    centroid.feature = d;
    nodeObjs.push(centroid);
  });

  d3.geom.voronoi().linkObjs(nodeObjs).forEach(function(linkObj) {
    var dx = linkObj.source.x - linkObj.target.x,
        dy = linkObj.source.y - linkObj.target.y;
    linkObj.distance = Math.sqrt(dx * dx + dy * dy);
    linkObjs.push(linkObj);
  });

  forceObj
      .gravity(0)
      .nodeObjs(nodeObjs)
      .linkObjs(linkObjs)
      .linkDistance(function(d) { return d.distance; })
      .start();

  var linkElms = svg.selectAll('line')
      .data(linkObjs)
    .enter().append('line')
      .attr('x1', function(d) { return d.source.x; })
      .attr('y1', function(d) { return d.source.y; })
      .attr('x2', function(d) { return d.target.x; })
      .attr('y2', function(d) { return d.target.y; });

  var nodeElms = svg.selectAll('g')
      .data(nodeObjs)
    .append('path')
      .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
      .attr('d', function(d) { return pathObj(d.feature); });

  var centroidElms = svg.selectAll('circle')
      .data(nodeObjs)
    .enter().append('circle')
      .attr('cx', function(d) { return -d.x; })
      .attr('cy', function(d) { return -d.y; })
      .call(forceObj.drag);

  forceObj.on('tick', function(e) {
    linkElms.attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });

    // nodeElms.attr('transform', function(d) {
    //   return 'translate(' + d.x + ',' + d.y + ')';
    // });

    centroidElms
      .attr('cx', function(d) { return -d.x; })
      .attr('cy', function(d) { return -d.y; });
  });
});

</script>
